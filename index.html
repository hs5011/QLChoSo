<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quản lý lấy số - Google Sheets API</title>
    <style>
        body { font-family: 'Segoe UI', Arial, sans-serif; background: linear-gradient(135deg, #e0e7ff 0%, #f8fafc 100%); min-height: 100vh; margin: 0; }
        .container { max-width: 700px; margin: 40px auto; background: #fff; border-radius: 16px; box-shadow: 0 4px 32px #0002; padding: 32px 24px; }
        h2 { color: #2d5be3; text-align: center; margin-bottom: 24px; }
        .section { margin-bottom: 32px; }
        label { display: block; margin-top: 12px; font-weight: 500; }
        input, select, textarea { padding: 10px; margin-top: 6px; width: 100%; border-radius: 6px; border: 1px solid #cbd5e1; font-size: 16px; }
        button { margin-top: 16px; padding: 10px 24px; border: none; background: #2d5be3; color: #fff; border-radius: 6px; font-size: 16px; cursor: pointer; transition: background 0.2s; }
        button:hover { background: #1e40af; }
        button.danger { background: #e53935; }
        button.danger:hover { background: #b91c1c; }
        .row { display: flex; gap: 16px; }
        .row > div { flex: 1; }
        table { width: 100%; border-collapse: collapse; margin-top: 16px; background: #f8fafc; border-radius: 8px; overflow: hidden; }
        th, td { border: 1px solid #e5e7eb; padding: 8px; text-align: left; }
        th { background: #e0e7ff; }
        .success { color: #388e3c; margin-top: 8px; }
        .error { color: #e53935; margin-top: 8px; }
        .dashboard { display: none; }
        .dashboard.active { display: block; }
        .logout-btn { float: right; background: #64748b; margin-top: 0; }
        @media (max-width: 600px) {
            .container { padding: 12px 2vw; }
            .row { flex-direction: column; gap: 0; }
        }
    </style>
</head>
<body>
    <div class="container">
        <h2>Quản lý lấy số (Google Sheets API)</h2>
        <!-- Đăng nhập -->
        <div class="section" id="loginSection">
            <label>Tên đăng nhập <input id="loginUsername"></label>
            <label>Mật khẩu <input id="loginPassword" type="password"></label>
            <button onclick="login()">Đăng nhập</button>
            <div id="loginMsg"></div>
        </div>

        <!-- Dashboard User -->
        <div class="dashboard" id="userDashboard">
            <div style="display: flex; justify-content: space-between; align-items: center;">
                <h3>Xin chào, <span id="userName"></span></h3>
                <button class="logout-btn" onclick="logout()">Đăng xuất</button>
            </div>
            <div class="section">
                <h4>Lấy số mới</h4>
                <form onsubmit="getNumber(event)">
                    <label>Nội dung <textarea id="userContent" rows="2" required></textarea></label>
                    <button type="submit">Lấy số</button>
                </form>
                <div id="userNumberMsg"></div>
            </div>
            <div class="section">
                <h4>Lịch sử lấy số của bạn</h4>
                <button onclick="loadUserHistory()">Tải lịch sử</button>
                <table id="userHistoryTable"><thead><tr><th>Số</th><th>Nội dung</th><th>Thời gian</th></tr></thead><tbody></tbody></table>
            </div>
        </div>

        <!-- Dashboard Admin -->
        <div class="dashboard" id="adminDashboard">
            <div style="display: flex; justify-content: space-between; align-items: center;">
                <h3>Quản trị viên: <span id="adminName"></span></h3>
                <button class="logout-btn" onclick="logout()">Đăng xuất</button>
            </div>
            <div class="row">
                <div class="section">
                    <h4>Thêm/Sửa người dùng</h4>
                    <label>Họ tên <input id="userName"></label>
                    <label>Tên đăng nhập <input id="userUsername"></label>
                    <label>Mật khẩu <input id="userPassword" type="text"></label>
                    <label>Quyền <select id="userIsAdmin"><option value="false">User</option><option value="true">Admin</option></select></label>
                    <button onclick="addOrEditUser()">Thêm/Sửa user</button>
                    <div id="userMsg"></div>
                </div>
                <div class="section">
                    <h4>Cập nhật số hiện tại</h4>
                    <label>Số hiện tại <input id="currentNumber" type="number"></label>
                    <button onclick="updateCurrentNumber()">Cập nhật số</button>
                    <div id="numberMsg"></div>
                </div>
            </div>
            <div class="section">
                <h4>Danh sách người dùng</h4>
                <table id="usersTable"><thead><tr><th>Họ tên</th><th>Username</th><th>Admin</th><th>Xóa</th><th>Sửa</th></tr></thead><tbody></tbody></table>
            </div>
            <div class="section">
                <h4>Lịch sử lấy số (tất cả)</h4>
                <button onclick="loadNumberHistory()">Tải lịch sử</button>
                <button onclick="exportExcel()">Xuất file Excel</button>
                <table id="historyTable"><thead><tr><th>Số</th><th>Nội dung</th><th>Người lấy</th><th>Thời gian</th></tr></thead><tbody></tbody></table>
            </div>
        </div>
    </div>

    <script>
        // Thay bằng link Web App của bạn
        const API_URL = 'https://script.google.com/macros/s/AKfycby7WMjgyEu-usvZn-knJGJHWMGp9uh0M_nwmRCCrOJmAiQzFlRTPq-KMg4oaSb05J4H/exec';
        let currentUser = null;
        let isAdmin = false;
        let allHistory = [];

        function showDashboard() {
            loginSection.style.display = 'none';
            if (isAdmin) {
                adminDashboard.classList.add('active');
                userDashboard.classList.remove('active');
                adminName.textContent = currentUser.name;
                loadUsers();
                loadCurrentNumber();
                loadNumberHistory();
            } else {
                userDashboard.classList.add('active');
                adminDashboard.classList.remove('active');
                userName.textContent = currentUser.name;
                loadUserHistory();
            }
        }
        function login() {
            fetch(API_URL, {
                method: 'POST',
                body: JSON.stringify({ action: 'login', username: loginUsername.value, password: loginPassword.value }),
                headers: {'Content-Type': 'application/json'}
            })
            .then(res => res.json())
            .then(data => {
                if (data.success) {
                    currentUser = data.user;
                    isAdmin = !!data.user.isAdmin;
                    showDashboard();
                } else {
                    loginMsg.innerHTML = '<span class="error">' + data.message + '</span>';
                }
            });
        }
        function logout() {
            currentUser = null;
            isAdmin = false;
            loginSection.style.display = '';
            adminDashboard.classList.remove('active');
            userDashboard.classList.remove('active');
            loginMsg.textContent = '';
        }
        // --- ADMIN ---
        function loadUsers() {
            fetch(API_URL, { method: 'POST', body: JSON.stringify({ action: 'getUsers' }), headers: {'Content-Type': 'application/json'} })
            .then(res => res.json())
            .then(data => {
                let html = '';
                data.users.forEach(u => {
                    html += `<tr><td>${u[0]}</td><td>${u[1]}</td><td>${u[3]}</td><td><button class='danger' onclick="deleteUser('${u[1]}')">Xóa</button></td><td><button onclick="editUser('${u[0]}','${u[1]}','${u[2]}','${u[3]}')">Sửa</button></td></tr>`;
                });
                usersTable.querySelector('tbody').innerHTML = html;
            });
        }
        function addOrEditUser() {
            const name = userName.value, username = userUsername.value, password = userPassword.value, isAdminVal = userIsAdmin.value === 'true';
            fetch(API_URL, { method: 'POST', body: JSON.stringify({ action: 'editUser', name, username, password, isAdmin: isAdminVal }), headers: {'Content-Type': 'application/json'} })
            .then(res => res.json())
            .then(data => {
                if (data.success) {
                    userMsg.innerHTML = '<span class="success">Đã thêm/sửa user!</span>';
                    loadUsers();
                } else {
                    // Nếu chưa có user thì thêm mới
                    fetch(API_URL, { method: 'POST', body: JSON.stringify({ action: 'addUser', name, username, password, isAdmin: isAdminVal }), headers: {'Content-Type': 'application/json'} })
                    .then(res => res.json()).then(data2 => {
                        if (data2.success) {
                            userMsg.innerHTML = '<span class="success">Đã thêm user!</span>';
                            loadUsers();
                        } else {
                            userMsg.innerHTML = '<span class="error">Lỗi: ' + (data2.message || 'Không thêm được user') + '</span>';
                        }
                    });
                }
            });
        }
        function deleteUser(username) {
            if (!confirm('Xóa user này?')) return;
            fetch(API_URL, { method: 'POST', body: JSON.stringify({ action: 'deleteUser', username }), headers: {'Content-Type': 'application/json'} })
            .then(res => res.json())
            .then(data => {
                if (data.success) {
                    userMsg.innerHTML = '<span class="success">Đã xóa user!</span>';
                    loadUsers();
                } else {
                    userMsg.innerHTML = '<span class="error">Lỗi: ' + (data.message || 'Không xóa được user') + '</span>';
                }
            });
        }
        function editUser(name, username, password, isAdmin) {
            userName.value = name;
            userUsername.value = username;
            userPassword.value = password;
            userIsAdmin.value = (isAdmin === 'TRUE' || isAdmin === true) ? 'true' : 'false';
        }
        function loadCurrentNumber() {
            fetch(API_URL, { method: 'POST', body: JSON.stringify({ action: 'getCurrentNumber' }), headers: {'Content-Type': 'application/json'} })
            .then(res => res.json())
            .then(data => {
                currentNumber.value = data.currentNumber;
            });
        }
        function updateCurrentNumber() {
            fetch(API_URL, { method: 'POST', body: JSON.stringify({ action: 'updateCurrentNumber', currentNumber: parseInt(currentNumber.value) }), headers: {'Content-Type': 'application/json'} })
            .then(res => res.json())
            .then(data => {
                if (data.success) {
                    numberMsg.innerHTML = '<span class="success">Đã cập nhật số!</span>';
                } else {
                    numberMsg.innerHTML = '<span class="error">Lỗi cập nhật số!</span>';
                }
            });
        }
        function loadNumberHistory() {
            fetch(API_URL, { method: 'POST', body: JSON.stringify({ action: 'getNumberHistory' }), headers: {'Content-Type': 'application/json'} })
            .then(res => res.json())
            .then(data => {
                allHistory = data.history;
                let html = '';
                data.history.forEach(h => {
                    html += `<tr><td>${h[0]}</td><td>${h[1]}</td><td>${h[2]}</td><td>${h[3]}</td></tr>`;
                });
                historyTable.querySelector('tbody').innerHTML = html;
            });
        }
        function exportExcel() {
            fetch(API_URL, { method: 'POST', body: JSON.stringify({ action: 'getExportUrl' }), headers: {'Content-Type': 'application/json'} })
            .then(res => res.json())
            .then(data => {
                if (data.url) window.open(data.url, '_blank');
            });
        }
        // --- USER ---
        function getNumber(e) {
            e.preventDefault();
            // Lấy số hiện tại
            fetch(API_URL, { method: 'POST', body: JSON.stringify({ action: 'getCurrentNumber' }), headers: {'Content-Type': 'application/json'} })
            .then(res => res.json())
            .then(data => {
                const number = parseInt(data.currentNumber);
                const content = userContent.value;
                const now = new Date();
                fetch(API_URL, {
                    method: 'POST',
                    body: JSON.stringify({
                        action: 'addNumberHistory',
                        number: number,
                        content: content,
                        userName: currentUser.name,
                        timestamp: now.toLocaleString('vi-VN'),
                        dateTime: now.toISOString()
                    }),
                    headers: {'Content-Type': 'application/json'}
                })
                .then(res => res.json())
                .then(data2 => {
                    if (data2.success) {
                        userNumberMsg.innerHTML = `<span class='success'>Bạn đã lấy số: <b>${number}</b></span>`;
                        userContent.value = '';
                        loadUserHistory();
                    } else {
                        userNumberMsg.innerHTML = `<span class='error'>Lỗi lấy số!</span>`;
                    }
                });
            });
        }
        function loadUserHistory() {
            fetch(API_URL, { method: 'POST', body: JSON.stringify({ action: 'getNumberHistory' }), headers: {'Content-Type': 'application/json'} })
            .then(res => res.json())
            .then(data => {
                let html = '';
                data.history.filter(h => h[2] === currentUser.name).forEach(h => {
                    html += `<tr><td>${h[0]}</td><td>${h[1]}</td><td>${h[3]}</td></tr>`;
                });
                userHistoryTable.querySelector('tbody').innerHTML = html;
            });
        }
    </script>
</body>
</html> 
